<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agenda Geral - AD Rodovia A</title>
    <link rel="stylesheet" href="../static/portal.css">
    <style>
        .agenda-card { border-left: 5px solid #dc2626; margin-bottom: 1rem; }
    </style>
</head>
<body>
    <div class="top-bar">
        <div class="brand">üìÖ Agenda 2026</div>
        <button onclick="history.back()" class="btn btn-back" style="text-decoration:none;">‚¨Ö Voltar</button>
    </div>

    <div class="container">
        <div class="card">
            <div class="form-grid-2">
                <div class="form-group">
                    <label>Filtrar por M√™s</label>
                    <select id="filtroMes" class="form-input" onchange="renderizarAgenda()">
                        <option value="todos">Todos</option>
                        <option value="1">Janeiro</option><option value="2">Fevereiro</option>
                        <option value="3">Mar√ßo</option><option value="4">Abril</option>
                        <option value="5">Maio</option><option value="6">Junho</option>
                        <option value="7">Julho</option><option value="8">Agosto</option>
                        <option value="9">Setembro</option><option value="10">Outubro</option>
                        <option value="11">Novembro</option><option value="12">Dezembro</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Pesquisar Evento</label>
                    <input type="text" id="busca" class="form-input" placeholder="Ex: Santa Ceia..." onkeyup="renderizarAgenda()">
                </div>
            </div>
        </div>

        <div id="listaEventos">
            <p style="text-align:center; padding:2rem;">Carregando eventos...</p>
        </div>
    </div>

    <script>
        let agendaGlobal = [];

        async function carregar() {
            try {
                // Endpoint correto
                const res = await fetch('https://api-escala.onrender.com/api/patrimonio/dados');
                const dados = await res.json();
                
                // IMPORTANTE: Aqui usamos 'agenda' (min√∫sculo) que vem da sua API
                agendaGlobal = dados.agenda || [];
                renderizarAgenda();
            } catch(e) {
                document.getElementById('listaEventos').innerHTML = '<p>Erro ao carregar agenda.</p>';
            }
        }

        function renderizarAgenda() {
            const container = document.getElementById('listaEventos');
            const mes = document.getElementById('filtroMes').value;
            const texto = document.getElementById('busca').value.toLowerCase();

            const filtrados = agendaGlobal.filter(item => {
                // IMPORTANTE: item.data (min√∫sculo)
                const dataObj = converterData(item.data);
                if(!dataObj) return false;
                
                const mesEvento = dataObj.getMonth() + 1;
                
                const matchMes = mes === 'todos' || mesEvento == mes;
                const matchTexto = (item.evento || '').toLowerCase().includes(texto);
                
                return matchMes && matchTexto;
            });

            if(filtrados.length === 0) {
                container.innerHTML = '<div class="card"><p>Nenhum evento encontrado.</p></div>';
                return;
            }

            // Ordena
            filtrados.sort((a,b) => converterData(a.data) - converterData(b.data));

            container.innerHTML = filtrados.map(item => `
                <div class="card agenda-card">
                    <div style="font-weight:bold; font-size:1.1rem; color:#1e293b;">${item.evento}</div>
                    <div style="color:#64748b; margin-top:5px; font-size:0.95rem;">
                        üìÖ ${item.data} &nbsp;|&nbsp; üìç ${item.local || 'Local a definir'}
                    </div>
                    ${item.responsavel ? `<div style="font-size:0.85rem; color:#94a3b8; margin-top:5px;">Resp: ${item.responsavel}</div>` : ''}
                </div>
            `).join('');
        }

        function converterData(str) {
            if(!str) return null;
            const p = str.split('/');
            return new Date(p[2], p[1]-1, p[0]);
        }

        carregar();
    </script>
</body>
</html>
