<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agenda Geral - AD Rodovia A</title>
    <link rel="stylesheet" href="../static/portal.css">
    <style>
        .agenda-card { border-left: 5px solid #dc2626; margin-bottom: 1rem; }
    </style>
</head>
<body>
    <div class="top-bar">
        <div class="brand">üìÖ Agenda 2026</div>
        <button onclick="history.back()" class="btn btn-back" style="text-decoration:none;">‚¨Ö Voltar</button>
    </div>

    <div class="container">
        <div class="card">
            <div class="form-grid-2">
                <div class="form-group">
                    <label>Filtrar por M√™s</label>
                    <select id="filtroMes" class="form-input" onchange="renderizarAgenda()">
                        <option value="todos">Todos</option>
                        <option value="1">Janeiro</option><option value="2">Fevereiro</option>
                        <option value="3">Mar√ßo</option><option value="4">Abril</option>
                        <option value="5">Maio</option><option value="6">Junho</option>
                        <option value="7">Julho</option><option value="8">Agosto</option>
                        <option value="9">Setembro</option><option value="10">Outubro</option>
                        <option value="11">Novembro</option><option value="12">Dezembro</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Pesquisar Evento</label>
                    <input type="text" id="busca" class="form-input" placeholder="Ex: Santa Ceia..." onkeyup="renderizarAgenda()">
                </div>
            </div>
        </div>

        <div id="listaEventos">
            <p style="text-align:center; padding:2rem;">Carregando eventos...</p>
        </div>
    </div>

    <script>
        let agendaGlobal = [];

        async function carregar() {
            try {
                // Endpoint correto
                const res = await fetch('https://api-escala.onrender.com/api/patrimonio/dados');
                const dados = await res.json();
                
                // IMPORTANTE: Aqui usamos 'agenda' (min√∫sculo) que vem da sua API
                agendaGlobal = dados.agenda || [];
                renderizarAgenda();
            } catch(e) {
                document.getElementById('listaEventos').innerHTML = '<p>Erro ao carregar agenda.</p>';
            }
        }

        const nomesMeses = ["", "JANEIRO", "FEVEREIRO", "MAR√áO", "ABRIL", "MAIO", "JUNHO", "JULHO", "AGOSTO", "SETEMBRO", "OUTUBRO", "NOVEMBRO", "DEZEMBRO"];

        function renderizarAgenda() {
            const container = document.getElementById('listaEventos');
            const mesFiltro = document.getElementById('filtroMes').value;
            const busca = document.getElementById('busca').value.toLowerCase();
        
            // Filtra e ordena
            let filtrados = agendaGlobal.filter(item => {
                const dataObj = converterData(item.data);
                if(!dataObj) return false;
                const matchMes = mesFiltro === 'todos' || (dataObj.getMonth() + 1) == mesFiltro;
                const matchBusca = (item.evento || '').toLowerCase().includes(busca);
                return matchMes && matchBusca;
            });
            filtrados.sort((a,b) => converterData(a.data) - converterData(b.data));
        
            // Agrupamento por M√™s
            let htmlFinal = "";
            let mesAtual = -1;
        
            filtrados.forEach(item => {
                const d = converterData(item.data);
                const m = d.getMonth() + 1;
        
                if (m !== mesAtual) {
                    mesAtual = m;
                    htmlFinal += `<div class="month-header">${nomesMeses[m]}</div>`;
                }
        
                const eAdmin = sessionStorage.getItem('token_sistema'); // Verifica se √© secret√°rio
        
                htmlFinal += `
                    <div class="card agenda-card">
                        <div class="card-content">
                            <strong>${item.evento}</strong>
                            <span>üìÖ ${item.data} | üìç ${item.local || 'Local a definir'}</span>
                            <small>Resp: ${item.responsavel || 'Secretaria'}</small>
                        </div>
                        ${eAdmin ? `<button class="btn-del" onclick="deletarEvento('${item.id}')">üóëÔ∏è</button>` : ''}
                    </div>
                `;
            });
        
            container.innerHTML = htmlFinal || '<p style="text-align:center;">Nenhum evento para este per√≠odo.</p>';
        }

        function converterData(str) {
            if(!str) return null;
            const p = str.split('/');
            return new Date(p[2], p[1]-1, p[0]);
        }

        carregar();
    </script>
</body>
</html>
