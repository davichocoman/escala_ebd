<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AD Rodovia A</title>
    <link rel="stylesheet" href="../static/styles.css">
    <style>
        /* --- CORRE√á√ÉO DO BUG DE VISIBILIDADE --- */
        /* Isso garante que as abas sumam quando n√£o estiverem ativas */
        .hidden { display: none !important; } 

        /* Layout Espec√≠fico do Painel */
        .dashboard-grid {
            display: grid;
            gap: 1.5rem;
        }
        .section-header {
            border-bottom: 2px solid #e5e7eb;
            padding-bottom: 0.5rem;
            margin-bottom: 1rem;
            color: #111827;
            font-size: 1.2rem;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        /* Cards */
        .event-card {
            background: white;
            padding: 1rem;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            border-left: 4px solid #ccc;
            margin-bottom: 0.8rem;
        }
        .card-oficial { border-left-color: #dc2626; background: #fff5f5; }
        .card-reserva { border-left-color: #2563eb; background: #eff6ff; }

        .card-meta {
            font-size: 0.85rem;
            color: #6b7280;
            display: flex;
            justify-content: space-between;
            margin-top: 5px;
        }
        
        .badge-status {
            font-size: 0.75rem;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: bold;
        }
        .bg-conf { background: #dcfce7; color: #166534; }
        .bg-pend { background: #fef9c3; color: #854d0e; }
        
        /* Filtros */
        .filter-bar {
            background: white;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1.5rem;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }
        .filter-select {
            padding: 8px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            flex: 1;
            min-width: 150px;
        }

        /* Rodap√© Azul */
        .footer-azul {
            background: linear-gradient(135deg, #0f172a 0%, #334155 100%) !important;
            margin-top: auto;
            color: white;
            padding: 2rem 0;
            text-align: center;
        }
    </style>
</head>
<body style="display: flex; flex-direction: column; min-height: 100vh; background-color: #f9fafb;">

    <header class="header" style="background: linear-gradient(135deg, #0f172a 0%, #334155 100%);">
        <div class="container">
            <div class="header-content">
                <h1>Painel da Igreja</h1>
                <p>Gest√£o de Eventos e Reservas</p>
            </div>
            
            <nav class="nav">
                <div class="nav-container">
                    <button id="tabVisao" class="nav-button active" onclick="mudarAba('Visao')">Vis√£o Geral</button>
                    <button id="tabAgenda" class="nav-button" onclick="mudarAba('Agenda')">Agenda Oficial</button>
                    <button id="tabReservas" class="nav-button" onclick="mudarAba('Reservas')">Reservas</button>
                </div>
            </nav>
        </div>
    </header>

    <main class="main" style="flex: 1;">
        <div class="container">

            <div id="loading" class="loading">
                <div class="spinner"></div><p>Carregando dados...</p>
            </div>

            <div id="contentVisao" class="content-section hidden">
                <div class="filters-card">
                    <h3 style="text-align: center; color: #374151;">üìÖ Resumo da Semana</h3>
                    <p style="text-align: center; font-size: 0.9rem; color: #6b7280;" id="periodoSemana">Calculando datas...</p>
                </div>

                <div class="dashboard-grid">
                    <div>
                        <div class="section-header">
                            <span style="color:#dc2626;">‚óè</span> Eventos Oficiais (Semana)
                        </div>
                        <div id="visaoAgendaContainer">
                            </div>
                    </div>
                    
                    <div>
                        <div class="section-header">
                            <span style="color:#2563eb;">‚óè</span> Reservas de Salas (Semana)
                        </div>
                        <div id="visaoReservasContainer">
                            </div>
                    </div>
                </div>
            </div>

            <div id="contentAgenda" class="content-section hidden">
                <div class="filter-bar">
                    <input type="text" id="searchAgenda" placeholder="Pesquisar evento..." class="filter-select" onkeyup="renderizarAgenda()">
                    <select id="filtroMesAgenda" class="filter-select" onchange="renderizarAgenda()">
                        <option value="todos">Todos os Meses</option>
                        <option value="1">Janeiro</option><option value="2">Fevereiro</option><option value="3">Mar√ßo</option>
                        <option value="4">Abril</option><option value="5">Maio</option><option value="6">Junho</option>
                        <option value="7">Julho</option><option value="8">Agosto</option><option value="9">Setembro</option>
                        <option value="10">Outubro</option><option value="11">Novembro</option><option value="12">Dezembro</option>
                    </select>
                    <select id="filtroRespAgenda" class="filter-select" onchange="renderizarAgenda()">
                        <option value="todos">Todos os Respons√°veis</option>
                    </select>
                </div>
                <div id="listaAgendaAnual"></div>
            </div>

            <div id="contentReservas" class="content-section hidden">
                <div class="filter-bar">
                    <input type="text" id="searchReservas" placeholder="Pesquisar reserva..." class="filter-select" onkeyup="renderizarReservas()">
                    <select id="filtroMesReservas" class="filter-select" onchange="renderizarReservas()">
                        <option value="todos">Todos os Meses</option>
                        <option value="1">Janeiro</option><option value="2">Fevereiro</option><option value="3">Mar√ßo</option>
                        <option value="4">Abril</option><option value="5">Maio</option><option value="6">Junho</option>
                        <option value="7">Julho</option><option value="8">Agosto</option><option value="9">Setembro</option>
                        <option value="10">Outubro</option><option value="11">Novembro</option><option value="12">Dezembro</option>
                    </select>
                    <select id="filtroRespReservas" class="filter-select" onchange="renderizarReservas()">
                        <option value="todos">Todos os Respons√°veis</option>
                    </select>
                </div>
                <div id="listaReservasAnual"></div>
            </div>

        </div>
    </main>

    <footer class="footer-azul">
        <div class="container">
            <p>¬© 2026 Patrim√¥nio - AD Rodovia A</p>
            <a href="admin.html" style="color: rgba(255,255,255,0.3); font-size: 0.8rem; text-decoration: none;">Admin</a>
        </div>
    </footer>

    <script>
        const API_URL = 'https://api-escala.onrender.com/api/patrimonio/dados';
        let dadosGlobais = { agenda: [], reservas: [] };

        document.addEventListener('DOMContentLoaded', async () => {
            const loading = document.getElementById('loading');
            try {
                const res = await fetch(API_URL);
                if (!res.ok) throw new Error("Falha na API");
                
                dadosGlobais = await res.json();
                
                // Popula filtros
                popularFiltroResponsavel(dadosGlobais.agenda, 'filtroRespAgenda');
                popularFiltroResponsavel(dadosGlobais.reservas, 'filtroRespReservas');

                // Inicia na Vis√£o Geral
                mudarAba('Visao'); 
            } catch (e) {
                console.error(e);
                loading.innerHTML = '<p style="color:red; text-align:center;">Erro ao carregar dados. Tente atualizar.</p>';
            } finally {
                // Garante que o loading some, mesmo se der erro
                if(dadosGlobais.agenda.length > 0 || dadosGlobais.reservas.length > 0) {
                    loading.classList.add('hidden');
                }
            }
        });

        function mudarAba(aba) {
            // 1. Esconde TODAS as se√ß√µes
            const secoes = ['Visao', 'Agenda', 'Reservas'];
            secoes.forEach(n => {
                const el = document.getElementById('content'+n);
                const btn = document.getElementById('tab'+n);
                
                if(el) el.classList.add('hidden');
                if(btn) btn.classList.remove('active');
            });

            // 2. Mostra S√ì a selecionada
            const elAtivo = document.getElementById('content'+aba);
            const btnAtivo = document.getElementById('tab'+aba);
            
            if(elAtivo) elAtivo.classList.remove('hidden');
            if(btnAtivo) btnAtivo.classList.add('active');

            // 3. Renderiza o conte√∫do
            if(aba === 'Visao') renderizarVisaoGeral();
            if(aba === 'Agenda') renderizarAgenda();
            if(aba === 'Reservas') renderizarReservas();
        }

        function renderizarVisaoGeral() {
            const hoje = new Date();
            hoje.setHours(0,0,0,0);
            
            // Define o fim da visualiza√ß√£o (Hoje + 6 dias)
            const fimSemana = new Date(hoje);
            fimSemana.setDate(hoje.getDate() + 6);

            document.getElementById('periodoSemana').innerText = 
                `De ${formatDateBr(hoje)} a ${formatDateBr(fimSemana)}`;

            // Filtro rigoroso de datas
            const agendaSemana = dadosGlobais.agenda.filter(item => {
                const d = parseDate(item.data);
                return d >= hoje && d <= fimSemana;
            }).sort((a,b) => parseDate(a.data) - parseDate(b.data));

            const reservasSemana = dadosGlobais.reservas.filter(item => {
                const d = parseDate(item.data);
                return d >= hoje && d <= fimSemana;
            }).sort((a,b) => parseDate(a.data) - parseDate(b.data));

            // HTML
            const divAgenda = document.getElementById('visaoAgendaContainer');
            const divReservas = document.getElementById('visaoReservasContainer');

            divAgenda.innerHTML = agendaSemana.length ? 
                agendaSemana.map(item => cardTemplate(item, 'oficial')).join('') : 
                '<div style="text-align:center; padding:1.5rem; color:#9ca3af; background:#f9fafb; border-radius:8px;">Nenhum evento oficial nestes 7 dias.</div>';

            divReservas.innerHTML = reservasSemana.length ? 
                reservasSemana.map(item => cardTemplate(item, 'reserva')).join('') : 
                '<div style="text-align:center; padding:1.5rem; color:#9ca3af; background:#f9fafb; border-radius:8px;">Nenhuma reserva de sala nestes 7 dias.</div>';
        }

        function filtrarDados(lista, idSearch, idMes, idResp) {
            const termo = document.getElementById(idSearch).value.toLowerCase();
            const mes = document.getElementById(idMes).value;
            const resp = document.getElementById(idResp).value;

            return lista.filter(item => {
                const d = parseDate(item.data);
                if (!d) return false;

                const matchTexto = (item.evento || '').toLowerCase().includes(termo) || 
                                   (item.local || '').toLowerCase().includes(termo);
                
                const matchMes = mes === 'todos' || (d.getMonth() + 1) == mes;
                const matchResp = resp === 'todos' || item.responsavel === resp;

                return matchTexto && matchMes && matchResp;
            }).sort((a,b) => parseDate(a.data) - parseDate(b.data));
        }

        function renderizarAgenda() {
            const filtrados = filtrarDados(dadosGlobais.agenda, 'searchAgenda', 'filtroMesAgenda', 'filtroRespAgenda');
            document.getElementById('listaAgendaAnual').innerHTML = filtrados.length ? 
                filtrados.map(item => cardTemplate(item, 'oficial')).join('') : 
                '<p class="empty-state" style="text-align:center; padding:2rem; color:#666;">Nenhum evento encontrado.</p>';
        }

        function renderizarReservas() {
            const filtrados = filtrarDados(dadosGlobais.reservas, 'searchReservas', 'filtroMesReservas', 'filtroRespReservas');
            document.getElementById('listaReservasAnual').innerHTML = filtrados.length ? 
                filtrados.map(item => cardTemplate(item, 'reserva')).join('') : 
                '<p class="empty-state" style="text-align:center; padding:2rem; color:#666;">Nenhuma reserva encontrada.</p>';
        }

        function cardTemplate(item, tipo) {
            const isReserva = tipo === 'reserva';
            const cssClass = isReserva ? 'card-reserva' : 'card-oficial';
            const statusBadge = isReserva 
                ? `<span class="badge-status ${item.status === 'Confirmado' ? 'bg-conf' : 'bg-pend'}">${item.status || 'Pendente'}</span>` 
                : '<span class="badge-status" style="background:#fee2e2; color:#991b1b;">Evento Oficial</span>';
            
            const timeInfo = isReserva ? `üïí ${item.inicio} √†s ${item.fim}` : '';

            return `
            <div class="event-card ${cssClass}">
                <div style="display:flex; justify-content:space-between; align-items:start;">
                    <div style="font-weight:bold; font-size:1.05rem; color:#1f2937; margin-bottom:5px;">${item.evento}</div>
                    ${statusBadge}
                </div>
                <div class="card-meta">
                    <span>üìÖ <strong>${item.data}</strong></span>
                    <span>üìç ${item.local}</span>
                </div>
                <div class="card-meta" style="margin-top:8px; border-top:1px solid rgba(0,0,0,0.05); padding-top:5px;">
                    <span>üë§ ${item.responsavel || 'Igreja'}</span>
                    <span>${timeInfo}</span>
                </div>
            </div>`;
        }

        function popularFiltroResponsavel(lista, idSelect) {
            const select = document.getElementById(idSelect);
            select.innerHTML = '<option value="todos">Todos os Respons√°veis</option>';
            const unicos = [...new Set(lista.map(i => i.responsavel).filter(Boolean))].sort();
            unicos.forEach(nome => {
                const opt = document.createElement('option');
                opt.value = nome;
                opt.innerText = nome;
                select.appendChild(opt);
            });
        }

        function parseDate(dateStr) {
            if(!dateStr || typeof dateStr !== 'string') return null;
            const parts = dateStr.split('/');
            if(parts.length !== 3) return null;
            return new Date(parts[2], parts[1]-1, parts[0]);
        }

        function formatDateBr(date) {
            return date.toLocaleDateString('pt-BR', {day:'2-digit', month:'2-digit'});
        }
    </script>
</body>
</html>
