<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Acesso - AD Rodovia A</title>

    <!-- PWA -->
    <link rel="manifest" href="/static/manifest.json">
    <meta name="theme-color" content="#0f172a">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <!-- √çcones -->
    <link rel="apple-touch-icon" sizes="180x180" href="/static/icons/ios/180.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/static/icons/ios/32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/static/icons/ios/16.png">

    <!-- Estilos -->
    <link rel="stylesheet" href="../static/portal.css">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        body {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            background: #0f172a;
            margin: 0;
            font-family: 'Segoe UI', sans-serif;
        }

        .login-box {
            background: white;
            padding: 2.5rem;
            border-radius: 16px;
            width: 90%;
            max-width: 400px;
            text-align: center;
            box-shadow: 0 10px 25px rgba(0,0,0,0.3);
        }

        .login-logo {
            width: 220px;
            margin-bottom: 1.5rem;
        }

        .form-group {
            margin-bottom: 1rem;
            position: relative;
            text-align: left;
        }

        .toggle-pass {
            position: absolute;
            right: 12px;
            top: 38px;
            cursor: pointer;
            color: #64748b;
            user-select: none;
        }

        .hint {
            font-size: 0.7rem;
            color: #64748b;
            margin-top: 4px;
        }
    </style>
</head>

<body>

<div class="login-box">
    <img src="../static/logo.png" alt="Logo AD Rodovia A" class="login-logo">

    <p style="color:#64748b; margin-bottom:20px; font-size:0.9rem;">
        Gest√£o Rodovia A
    </p>

    <form onsubmit="fazerLogin(event)">

        <!-- CPF -->
        <div class="form-group">
            <label>CPF</label>
            <input
                type="text"
                id="login"
                class="form-input"
                placeholder="Somente n√∫meros"
                inputmode="numeric"
                required
            >
        </div>
        <div id="perfilDetectado" style="font-size:0.75rem; color:#475569; margin-bottom:8px;"></div>
        <!-- SENHA / NASCIMENTO -->
        <div class="form-group">
            <label id="labelPass">Senha ou Nascimento</label>

            <input
                type="password"
                id="pass"
                class="form-input"
                placeholder="Senha ou DD/MM/AAAA"
                autocomplete="current-password"
                required
            >

            <span class="toggle-pass" id="togglePass">üëÅÔ∏è</span>
            <div class="hint" id="passHint">
                Membros: data de nascimento
            </div>
        </div>

        <button
            type="submit"
            class="btn btn-primary"
            style="width:100%; padding:12px; font-weight:bold;"
        >
            Entrar no Sistema
        </button>
        <button
            type="button"
            id="btnBiometria"
            class="btn"
            style="width:100%; margin-top:10px; display:none;"
        >
            üîê Entrar com biometria
        </button>

    </form>

    <div style="margin-top:20px; border-top:1px solid #e2e8f0; padding-top:15px;">
        <a href="/" style="text-decoration:none; color:#3b82f6; font-size:0.85rem;">
            Acessar EBD (P√∫blico)
        </a>
    </div>
</div>

<script>
/* ===============================
   VISUALIZAR / OCULTAR SENHA
================================ */
document.getElementById("togglePass").addEventListener("click", () => {
    const pass = document.getElementById("pass");
    pass.type = pass.type === "password" ? "text" : "password";
});

/* ===============================
   CPF: SOMENTE N√öMEROS
================================ */
document.getElementById("login").addEventListener("input", (e) => {
    e.target.value = e.target.value.replace(/\D/g, "");
});

/* ===============================
   SENHA / DATA INTELIGENTE
================================ */
const passInput = document.getElementById("pass");
const hint = document.getElementById("passHint");
const loginInput = document.getElementById("login");
const perfilLabel = document.getElementById("perfilDetectado");

loginInput.addEventListener("input", () => {
    const valor = loginInput.value.trim();

    // Se tiver letra -> administra√ß√£o (improv√°vel no campo numeric, mas mantendo a l√≥gica)
    if (/[a-zA-Z]/.test(valor)) {
        perfilLabel.innerText = "Perfil detectado: Administra√ß√£o";
        passInput.placeholder = "Senha do sistema";
        hint.innerText = "Use sua senha";
        return;
    }

    // Se s√≥ n√∫meros e >= 6 d√≠gitos -> membro
    if (/^\d+$/.test(valor) && valor.length >= 6) {
        perfilLabel.innerText = "Perfil detectado: Membro";
        passInput.placeholder = "DD/MM/AAAA";
        hint.innerText = "Data de nascimento";
        return;
    }

    perfilLabel.innerText = "";
});

passInput.addEventListener("input", (e) => {
    let v = e.target.value;
    
    // Se for perfil admin (detectado pela l√≥gica acima ou se digitar letras) n√£o aplica m√°scara
    if (perfilLabel.innerText.includes("Administra√ß√£o")) return;

    // M√°scara de data apenas para n√∫meros
    v = v.replace(/\D/g, "");
    if (v.length >= 3 && v.length <= 4) {
        v = v.replace(/^(\d{2})(\d+)/, "$1/$2");
    } else if (v.length >= 5) {
        v = v.replace(/^(\d{2})(\d{2})(\d+)/, "$1/$2/$3");
    }
    e.target.value = v.slice(0, 10);
});

/* ===============================
   LOGIN COM SENHA + REGISTRO BIOMETRIA
================================ */
async function fazerLogin(e) {
    e.preventDefault();

    const btn = document.querySelector("button[type='submit']");
    btn.disabled = true;
    btn.innerText = "Autenticando...";

    try {
        const login = document.getElementById("login").value.trim();
        const password = document.getElementById("pass").value.trim().replace(/\s+/g, "");

        const res = await fetch(
            "https://api-escala.onrender.com/api/auth/login",
            {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ login, password })
            }
        );

        const data = await res.json();

        if (res.ok) {
            // Login Sucesso: Salva sess√£o
            sessionStorage.setItem("usuario_sistema", JSON.stringify(data.user));
            sessionStorage.setItem("token_sistema", data.token);

            // --- L√ìGICA DE REGISTRO DA BIOMETRIA ---
            if (window.PublicKeyCredential) {
                // Verifica se j√° tem biometria salva para este usu√°rio
                const bioSalva = localStorage.getItem("biometria_usuario");
                const bioObj = bioSalva ? JSON.parse(bioSalva) : null;
                
                // Se n√£o tiver biometria ou for usu√°rio diferente, oferece
                if (!bioObj || bioObj.login !== login) {
                    const ativar = confirm("Deseja ativar login por biometria/FaceID para facilitar o pr√≥ximo acesso?");
                    
                    if (ativar) {
                        try {
                            // 1. CRIA√á√ÉO DA CREDENCIAL (Isso que faltava!)
                            // Gera um desafio aleat√≥rio
                            const challenge = new Uint8Array(32);
                            window.crypto.getRandomValues(challenge);

                            const userId = new Uint8Array(16);
                            window.crypto.getRandomValues(userId);

                            await navigator.credentials.create({
                                publicKey: {
                                    challenge: challenge,
                                    rp: { name: "Gest√£o Rodovia A" },
                                    user: {
                                        id: userId,
                                        name: login,
                                        displayName: data.user.NOME || login
                                    },
                                    pubKeyCredParams: [{ type: "public-key", alg: -7 }],
                                    timeout: 60000,
                                    authenticatorSelection: { authenticatorAttachment: "platform" } // Usa FaceID/TouchID do dispositivo
                                }
                            });

                            // 2. Se o navegador criou com sucesso, salva os dados no LocalStorage
                            localStorage.setItem(
                                "biometria_usuario",
                                JSON.stringify({
                                    login,
                                    perfil: data.user.PERFIL,
                                    token: data.token, // Guardamos o token para o futuro (Nota: idealmente o token tem validade longa)
                                    nome: data.user.NOME
                                })
                            );
                            
                            Swal.fire({
                                toast: true, position: 'top-end', icon: 'success', 
                                title: 'Biometria ativada!', showConfirmButton: false, timer: 1500
                            });

                        } catch (errBio) {
                            console.error("Erro ao criar biometria:", errBio);
                            // N√£o impede o login, s√≥ avisa
                        }
                    }
                }
            }
            // ---------------------------------------

            // Redirecionamento
            const perfil = data.user.PERFIL.toUpperCase();
            setTimeout(() => {
                if (perfil === "ADMIN" || perfil === "SECRETARIA") window.location.href = "/secretaria";
                else if (perfil === "PASTOR") window.location.href = "/pastor";
                else window.location.href = "/membro";
            }, 500);

        } else {
            Swal.fire("Erro", data.detail || "Credenciais inv√°lidas", "error");
        }
    } catch (err) {
        Swal.fire("Erro", "Falha na conex√£o com o servidor", "error");
    } finally {
        btn.disabled = false;
        btn.innerText = "Entrar no Sistema";
    }
}

/* ===============================
   LOGIN VIA BIOMETRIA (Bot√£o)
================================ */
const btnBio = document.getElementById("btnBiometria");

// S√≥ mostra o bot√£o se tiver dados salvos no localStorage E o navegador suportar
if (window.PublicKeyCredential && localStorage.getItem("biometria_usuario")) {
    const dadosBio = JSON.parse(localStorage.getItem("biometria_usuario"));
    // Opcional: Mostrar nome do usu√°rio no bot√£o
    // btnBio.innerText = `üîê Entrar como ${dadosBio.nome.split(' ')[0]}`;
    btnBio.style.display = "block";
}

btnBio.addEventListener("click", async () => {
    try {
        // Gera desafio aleat√≥rio
        const challenge = new Uint8Array(32);
        window.crypto.getRandomValues(challenge);

        // Pede autentica√ß√£o ao sistema (FaceID/Digital)
        const assertion = await navigator.credentials.get({
            publicKey: {
                challenge: challenge,
                timeout: 60000,
                userVerification: "required"
            }
        });

        if (assertion) {
            // Se o sistema operacional validou a digital/face:
            const dados = JSON.parse(localStorage.getItem("biometria_usuario"));
            
            if (!dados) {
                Swal.fire("Erro", "Dados de biometria n√£o encontrados. Fa√ßa login com senha novamente.", "error");
                return;
            }

            // Restaura a sess√£o
            sessionStorage.setItem("token_sistema", dados.token);
            
            // Precisamos recuperar o objeto 'user' completo. 
            // Como no localStorage simplificado talvez n√£o tenhamos tudo, 
            // idealmente buscar√≠amos na API usando o token, mas para simplificar o cache local:
            // Vamos simular o objeto user b√°sico necess√°rio para os pain√©is funcionarem
            const userSimulado = {
                NOME: dados.nome,
                PERFIL: dados.perfil,
                CPF: dados.login
            };
            sessionStorage.setItem("usuario_sistema", JSON.stringify(userSimulado));

            // Redireciona
            if (dados.perfil === "ADMIN" || dados.perfil === "SECRETARIA") {
                window.location.href = "/secretaria";
            } else if (dados.perfil === "PASTOR") {
                window.location.href = "/pastor";
            } else {
                window.location.href = "/membro";
            }
        }
    } catch (e) {
        console.error(e);
        Swal.fire({
            title: "N√£o reconhecido",
            text: "N√£o foi poss√≠vel validar a biometria. Use sua senha.",
            icon: "error"
        });
    }
});
</script>

</body>
</html>
