<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Acesso - AD Rodovia A</title>

    <!-- PWA -->
    <link rel="manifest" href="/static/manifest.json">
    <meta name="theme-color" content="#0f172a">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <!-- √çcones -->
    <link rel="apple-touch-icon" sizes="180x180" href="/static/icons/ios/180.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/static/icons/ios/32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/static/icons/ios/16.png">

    <!-- Estilos -->
    <link rel="stylesheet" href="../static/portal.css">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        body {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 90vh;
            background: #0f172a;
            margin: 0;
            font-family: 'Segoe UI', sans-serif;
        }

        .login-box {
            background: white;
            padding: 2.5rem;
            border-radius: 16px;
            width: 85%;
            max-width: 400px;
            text-align: center;
            box-shadow: 0 10px 25px rgba(0,0,0,0.3);
        }

        .login-logo {
            width: 220px;
            margin-bottom: 1.5rem;
        }

        .form-group {
            margin-bottom: 0.8rem;
            position: relative;
            text-align: left;
        }

        .toggle-pass {
            position: absolute;
            right: 12px;
            top: 38px;
            cursor: pointer;
            color: #64748b;
            user-select: none;
        }

        .hint {
            font-size: 0.7rem;
            color: #64748b;
            margin-top: 4px;
        }
    </style>
</head>

<body>
    
    <div id="pwa-install-banner" class="install-banner hidden">
        <div style="display:flex; align-items:center; gap:10px;">
            <span class="material-icons">install_mobile</span>
            <div style="text-align:left;">
                <div style="font-weight:bold; font-size:0.9rem;">App AD Rodovia A</div>
                <div style="font-size:0.75rem; opacity:0.8;">Instale para acesso r√°pido</div>
    </div>

<div class="login-box">
    <img src="../static/logo.png" alt="Logo AD Rodovia A" class="login-logo">

    <p style="color:#64748b; margin-bottom:20px; font-size:0.9rem;">
        Gest√£o Rodovia A
    </p>

    <div style="margin-top:20px; border-top:1px solid #e2e8f0; padding-top:15px;">
        <a href="/ebd" style="text-decoration:none; color:#3b82f6; font-size:0.85rem;">
            Acessar Site da EBD (P√∫blico)
        </a>
    </div>

    <form onsubmit="fazerLogin(event)">

        <!-- CPF -->
        <div class="form-group">
            <label>CPF</label>
            <input
                type="text"
                id="login"
                class="form-input"
                placeholder="Somente n√∫meros"
                inputmode="numeric"
                required
            >
        </div>
        <div id="perfilDetectado" style="font-size:0.75rem; color:#475569; margin-bottom:8px;"></div>
        <!-- SENHA / NASCIMENTO -->
        <div class="form-group">
            <label id="labelPass">Senha ou Nascimento</label>

            <input
                type="password"
                id="pass"
                class="form-input"
                placeholder="Senha ou DD/MM/AAAA"
                autocomplete="current-password"
                required
            >

            <span class="toggle-pass" id="togglePass">üëÅÔ∏è</span>
            <div class="hint" id="passHint">
                Membros: data de nascimento
            </div>
        </div>

        <button
            type="submit"
            class="btn btn-primary"
            style="width:100%; padding:12px; font-weight:bold;"
        >
            Entrar no Sistema
        </button>
        <button
            type="button"
            id="btnBiometria"
            class="btn"
            style="width:100%; margin-top:10px; display:none;"
        >
            üîê Entrar com biometria
        </button>

    </form>

    <!-- <div style="margin-top: 15px; text-align: center;">
        <button type="button" onclick="resetarBiometria()" style="background: none; border: none; color: #ef4444; font-size: 0.8rem; cursor: pointer; text-decoration: underline;">
            [DEV] Limpar Biometria Salva
        </button>
    </div> -->
</div>

<script>
/* ===============================
   UTILIT√ÅRIOS: CONVERS√ÉO DE DADOS (CRUCIAL)
================================ */
// Converte ArrayBuffer para String Base64 para salvar no LocalStorage
function bufferToBase64(buffer) {
    let binary = '';
    const bytes = new Uint8Array(buffer);
    const len = bytes.byteLength;
    for (let i = 0; i < len; i++) {
        binary += String.fromCharCode(bytes[i]);
    }
    return window.btoa(binary);
}

// Converte String Base64 de volta para ArrayBuffer para enviar ao navegador
function base64ToBuffer(base64) {
    const binary_string = window.atob(base64);
    const len = binary_string.length;
    const bytes = new Uint8Array(len);
    for (let i = 0; i < len; i++) {
        bytes[i] = binary_string.charCodeAt(i);
    }
    return bytes.buffer;
}

// Cria um ID de usu√°rio fixo a partir do CPF (para o Android n√£o achar que √© outra pessoa)
function strToBuffer(str) {
    const encoder = new TextEncoder();
    return encoder.encode(str);
}

/* ===============================
   INTERFACE E M√ÅSCARAS
================================ */
document.getElementById("togglePass").addEventListener("click", () => {
    const pass = document.getElementById("pass");
    pass.type = pass.type === "password" ? "text" : "password";
});

document.getElementById("login").addEventListener("input", (e) => {
    e.target.value = e.target.value.replace(/\D/g, "");
});

const passInput = document.getElementById("pass");
const hint = document.getElementById("passHint");
const loginInput = document.getElementById("login");
const perfilLabel = document.getElementById("perfilDetectado");

loginInput.addEventListener("input", () => {
    const valor = loginInput.value.trim();
    if (/[a-zA-Z]/.test(valor)) {
        perfilLabel.innerText = "Perfil detectado: Administra√ß√£o";
        passInput.placeholder = "Senha do sistema";
        return;
    }
    if (/^\d+$/.test(valor) && valor.length >= 6) {
        perfilLabel.innerText = "Perfil detectado: Membro/Pastor";
        passInput.placeholder = "Senha ou Nascimento";
        return;
    }
    perfilLabel.innerText = "";
});

passInput.addEventListener("input", (e) => {
    let v = e.target.value;
    if (/[a-zA-Z]/.test(v)) {
        hint.innerText = "Senha alfanum√©rica detectada";
        return; 
    }
    hint.innerText = "Membros: data de nascimento";
    v = v.replace(/\D/g, "");
    if (v.length >= 3 && v.length <= 4) v = v.replace(/^(\d{2})(\d+)/, "$1/$2");
    else if (v.length >= 5) v = v.replace(/^(\d{2})(\d{2})(\d+)/, "$1/$2/$3");
    if (v.length <= 10) e.target.value = v;
});

/* ===============================
   LOGIN COM SENHA + REGISTRO
================================ */
async function fazerLogin(e) {
    e.preventDefault();
    const btn = document.querySelector("button[type='submit']");
    btn.disabled = true;
    btn.innerText = "Autenticando...";

    try {
        const login = document.getElementById("login").value.trim();
        const password = document.getElementById("pass").value.trim();

        const res = await fetch("https://api-escala.onrender.com/api/auth/login", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ login, password })
        });

        const data = await res.json();

        if (res.ok) {
            // 1. Salva Sess√£o
            sessionStorage.setItem("usuario_sistema", JSON.stringify(data.user));
            sessionStorage.setItem("token_sistema", data.token);

            // 2. Tenta Registrar Biometria (Fluxo Pausado)
            if (window.PublicKeyCredential) {
                const bioSalva = localStorage.getItem("biometria_usuario");
                const bioObj = bioSalva ? JSON.parse(bioSalva) : null;

                // Se n√£o tem biometria para este login, ou se a biometria salva √© de outro CPF
                if (!bioObj || bioObj.login !== login) {
                    await registrarBiometria(login, data.user, data.token);
                }
            }

            // 3. Redireciona
            irParaHome(data.user.PERFIL);

        } else {
            Swal.fire("Erro", data.detail || "Credenciais inv√°lidas", "error");
            btn.disabled = false;
            btn.innerText = "Entrar no Sistema";
        }
    } catch (err) {
        console.error(err);
        Swal.fire("Erro", "Falha na conex√£o com o servidor", "error");
        btn.disabled = false;
        btn.innerText = "Entrar no Sistema";
    }
}

// Fun√ß√£o de Registro da Biometria
async function registrarBiometria(login, user, token) {
    const result = await Swal.fire({
        title: 'Facilitar acesso?',
        text: "Deseja entrar com Digital/Face ID na pr√≥xima vez?",
        icon: 'question',
        showCancelButton: true,
        confirmButtonColor: '#3b82f6',
        confirmButtonText: 'Sim, cadastrar',
        cancelButtonText: 'Agora n√£o'
    });

    if (!result.isConfirmed) return;

    try {
        // Op√ß√µes de Cria√ß√£o
        const publicKeyCredentialCreationOptions = {
            challenge: window.crypto.getRandomValues(new Uint8Array(32)),
            rp: {
                name: "Gest√£o Rodovia A",
                id: window.location.hostname // Importante para o Android vincular ao dom√≠nio
            },
            user: {
                id: strToBuffer(login), // ID fixo baseado no CPF
                name: login,
                displayName: user.NOME || login
            },
            pubKeyCredParams: [{alg: -7, type: "public-key"}, {alg: -257, type: "public-key"}],
            authenticatorSelection: {
                authenticatorAttachment: "platform", // For√ßa usar o leitor do celular
                userVerification: "required",
                requireResidentKey: false // N√£o exige chave residente (mais compat√≠vel)
            },
            timeout: 60000,
            attestation: "none"
        };

        const credential = await navigator.credentials.create({
            publicKey: publicKeyCredentialCreationOptions
        });

        // Converte o ID da credencial (buffer) para Base64 para salvar no texto
        const rawIdBase64 = bufferToBase64(credential.rawId);

        // Salva tudo no LocalStorage
        localStorage.setItem("biometria_usuario", JSON.stringify({
            login: login,
            perfil: user.PERFIL,
            token: token,
            nome: user.NOME,
            credentialId: rawIdBase64 // <--- AQUI EST√Å O SEGREDO
        }));

        await Swal.fire({
            icon: 'success',
            title: 'Biometria Salva!',
            text: 'Da pr√≥xima vez, clique no bot√£o "Entrar com biometria".',
            timer: 2000,
            showConfirmButton: false
        });

    } catch (err) {
        console.error("Erro ao registrar:", err);
        // N√£o mostra erro para o usu√°rio para n√£o travar o fluxo, apenas segue o login
    }
}

/* ===============================
   LOGIN VIA BIOMETRIA (BOT√ÉO)
================================ */
const btnBio = document.getElementById("btnBiometria");

// S√≥ mostra o bot√£o se tivermos dados E o ID da credencial salvos
const dadosLocais = localStorage.getItem("biometria_usuario");
if (window.PublicKeyCredential && dadosLocais) {
    btnBio.style.display = "block";
}

btnBio.addEventListener("click", async () => {
    try {
        const dados = JSON.parse(dadosLocais);
        if (!dados || !dados.credentialId) {
            Swal.fire("Aten√ß√£o", "Dados biom√©tricos inv√°lidos. Fa√ßa login com senha novamente para recadastrar.", "warning");
            return;
        }

        // Converte o ID salvo de volta para Buffer
        const credentialIdBuffer = base64ToBuffer(dados.credentialId);

        // Solicita autentica√ß√£o ESPEC√çFICA para esta credencial
        const assertion = await navigator.credentials.get({
            publicKey: {
                challenge: window.crypto.getRandomValues(new Uint8Array(32)),
                timeout: 60000,
                rpId: window.location.hostname,
                userVerification: "required",
                allowCredentials: [{
                    id: credentialIdBuffer, // <--- MANDAMOS O ID EXATO QUE O CELULAR QUER
                    type: 'public-key',
                    transports: ['internal']
                }]
            }
        });

        if (assertion) {
            // Sucesso!
            sessionStorage.setItem("token_sistema", dados.token);
            sessionStorage.setItem("usuario_sistema", JSON.stringify({ 
                NOME: dados.nome, 
                PERFIL: dados.perfil, 
                CPF: dados.login 
            }));

            irParaHome(dados.perfil);
        }
    } catch (e) {
        console.error(e);
        let msg = "Falha na leitura biom√©trica.";
        if (e.name === "NotAllowedError") msg = "Leitura cancelada ou n√£o autorizada.";
        
        Swal.fire({
            title: "Erro no Acesso",
            text: msg + " Tente novamente ou use a senha.",
            icon: "error"
        });
    }
});

function irParaHome(perfil) {
    const p = perfil.toUpperCase();
    if (p === "ADMIN" || p === "SECRETARIA") window.location.href = "/secretaria";
    else if (p === "PASTOR") window.location.href = "/pastor";
    else window.location.href = "/membro";
}
// function resetarBiometria() {
//     if (confirm("Isso vai apagar a configura√ß√£o biom√©trica deste dispositivo. Continuar?")) {
//         localStorage.removeItem("biometria_usuario");
//         alert("Limpeza conclu√≠da! Fa√ßa login novamente para ver o prompt.");
//         window.location.reload();
//     }
// }
</script>
</body>
</html>
