<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portal Integrado - AD Rodovia A</title>
    <link rel="stylesheet" href="../static/styles.css">
    <style>
        /* --- Layout Base --- */
        body { margin: 0; font-family: 'Segoe UI', sans-serif; background-color: #f1f5f9; }
        .dashboard-layout { display: flex; min-height: 100vh; }

        /* --- Sidebar (Menu Lateral) --- */
        .sidebar {
            width: 260px;
            background-color: #0f172a;
            color: white;
            display: flex;
            flex-direction: column;
            position: fixed;
            height: 100%;
            transition: transform 0.3s ease;
            z-index: 1000;
        }
        .sidebar-header { padding: 1.5rem; border-bottom: 1px solid #1e293b; }
        .user-info { font-size: 0.9rem; color: #94a3b8; margin-top: 5px; }
        .menu-items { flex: 1; padding: 1rem 0; overflow-y: auto; }
        .menu-btn {
            display: flex; align-items: center; width: 100%; padding: 1rem 1.5rem;
            color: #cbd5e1; background: none; border: none; text-align: left;
            cursor: pointer; font-size: 1rem; transition: all 0.2s;
        }
        .menu-btn:hover, .menu-btn.active { background-color: #1e293b; color: white; border-left: 4px solid #3b82f6; }
        .menu-icon { margin-right: 10px; width: 20px; text-align: center; }

        /* --- Conteﾃｺdo Principal --- */
        .main-content {
            flex: 1;
            margin-left: 260px;
            padding: 2rem;
            width: 100%;
        }

        /* --- Mobile Responsive --- */
        .mobile-toggle-btn {
            display: none; /* Escondido no PC */
            position: fixed; top: 15px; right: 15px; z-index: 2000;
            background: #0f172a; color: white; border: none;
            padding: 10px 15px; border-radius: 6px; font-size: 1.2rem; cursor: pointer;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }

        @media (max-width: 768px) {
            .sidebar { transform: translateX(-100%); }
            .sidebar.open { transform: translateX(0); }
            .main-content { margin-left: 0; padding: 1rem; padding-top: 4rem; }
            .mobile-toggle-btn { display: block; } /* Mostra no Mobile */
        }

        /* --- Estilos de Cards e Tabelas --- */
        .panel-card { background: white; border-radius: 8px; padding: 1.5rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 1.5rem; }
        .panel-title { font-size: 1.25rem; font-weight: bold; color: #1e293b; margin-bottom: 1rem; border-bottom: 2px solid #f1f5f9; padding-bottom: 0.5rem; display: flex; justify-content: space-between; align-items: center; }

        .data-table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.9rem; }
        .data-table th { background: #f8fafc; text-align: left; padding: 10px; color: #64748b; font-weight: 600; border-bottom: 2px solid #e2e8f0; }
        .data-table td { padding: 10px; border-bottom: 1px solid #e2e8f0; color: #334155; }
        .data-table tr:hover { background: #f1f5f9; }

        /* --- Botﾃｵes e Badges --- */
        .btn-action { padding: 5px 10px; border-radius: 4px; border: none; cursor: pointer; font-size: 0.8rem; margin-right: 5px; }
        .btn-edit { background: #e0f2fe; color: #0284c7; }
        .btn-delete { background: #fee2e2; color: #dc2626; }
        .btn-add { background: #16a34a; color: white; padding: 8px 16px; border-radius: 6px; border: none; cursor: pointer; font-weight: bold; }
        
        .badge { padding: 3px 8px; border-radius: 10px; font-size: 0.75rem; font-weight: bold; }
        .badge-admin { background: #fce7f3; color: #db2777; }
        .badge-pastor { background: #e0e7ff; color: #4f46e5; }
        .badge-membro { background: #dcfce7; color: #166534; }

        /* --- Formulﾃ｡rios (Inputs) --- */
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px; }
        .form-group { margin-bottom: 10px; }
        .form-group label { display: block; margin-bottom: 5px; color: #475569; font-size: 0.9rem; font-weight: 500; }
        .form-input { width: 100%; padding: 8px; border: 1px solid #cbd5e1; border-radius: 4px; }
        
        /* Modal Simples */
        .modal-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); display:flex; align-items:center; justify-content:center; z-index:2000; }
        .hidden { display: none !important; }
    </style>
</head>
<body>

    <button class="mobile-toggle-btn" onclick="toggleSidebar()">笘ｰ</button>

    <div class="dashboard-layout">
        
        <nav class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <h2 style="font-size:1.2rem; margin:0;">AD Rodovia A</h2>
                <div class="user-info" id="userInfo">Carregando...</div>
            </div>

            <div class="menu-items" id="menuContainer">
                </div>

            <div style="padding: 1.5rem;">
                <button onclick="logout()" style="width:100%; padding:0.5rem; background:#334155; color:white; border:none; border-radius:4px; cursor:pointer;">Sair</button>
            </div>
        </nav>

        <main class="main-content" id="mainContainer">
            <div class="panel-card">
                <h2>Bem-vindo</h2>
                <p>Selecione uma opﾃｧﾃ｣o no menu.</p>
            </div>
        </main>

    </div>

    <div id="modalForm" class="modal-overlay hidden">
        <div class="panel-card" style="width: 90%; max-width: 500px; margin: 0;">
            <div class="panel-title">
                <span id="modalTitle">Novo Cadastro</span>
                <button onclick="fecharModal()" style="background:none; border:none; font-size:1.5rem; cursor:pointer;">&times;</button>
            </div>
            <div id="modalBody"></div>
        </div>
    </div>

    <script>
        const API_BASE = 'https://api-escala.onrender.com/api';
        let usuario = null;
        let token = null;

        // --- INICIALIZAﾃﾃグ ---
        document.addEventListener('DOMContentLoaded', () => {
            const userStr = sessionStorage.getItem('usuario_sistema');
            token = sessionStorage.getItem('token_sistema'); // Token fictﾃｭcio para "autorizar"
            
            if (!userStr) {
                window.location.href = '/login';
                return;
            }
            usuario = JSON.parse(userStr);
            
            // Preenche Header da Sidebar
            document.getElementById('userInfo').innerHTML = `
                <strong>${usuario.NOME ? usuario.NOME.split(' ')[0] : 'Usuﾃ｡rio'}</strong><br>
                <span style="font-size:0.8rem; text-transform:uppercase; color:#38bdf8;">${usuario.PERFIL}</span>
            `;

            gerarMenu(usuario.PERFIL);
            
            // Carrega pﾃ｡gina inicial baseada no perfil
            if(usuario.PERFIL === 'PASTOR') carregarVisaoPastor();
            else if (['SECRETARIA', 'ADMIN'].includes(usuario.PERFIL)) carregarVisaoSecretaria();
            else carregarVisaoMembro();
        });

        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('open');
        }

        function logout() {
            sessionStorage.clear();
            window.location.href = '/login'; // <--- CORREﾃﾃグ DO REDIRECIONAMENTO
        }

        // --- GERADOR DE MENUS ---
        function gerarMenu(perfil) {
            const menu = document.getElementById('menuContainer');
            let html = '';

            html += `<button class="menu-btn" onclick="abrirEBD()"><span class="menu-icon">当</span> Ir para EBD</button>`;

            if (perfil === 'PASTOR') {
                html += `<button class="menu-btn active" onclick="carregarVisaoPastor()"><span class="menu-icon">套</span> Minha Agenda</button>`;
                html += `<button class="menu-btn" onclick="carregarMembrosRead()"><span class="menu-icon">則</span> Membros</button>`;
            } 
            else if (['SECRETARIA', 'ADMIN'].includes(perfil)) {
                html += `<button class="menu-btn" onclick="carregarVisaoSecretaria()"><span class="menu-icon">匠</span> Inﾃｭcio</button>`;
                html += `<button class="menu-btn" onclick="carregarCRUDMembros()"><span class="menu-icon">則</span> Gestﾃ｣o Membros</button>`;
                html += `<button class="menu-btn" onclick="carregarGestaoAgendaPastor()"><span class="menu-icon">藻</span> Agenda Pastor</button>`;
            } 
            else { 
                html += `<button class="menu-btn" onclick="carregarVisaoMembro()"><span class="menu-icon">側</span> Meus Dados</button>`;
                html += `<button class="menu-btn" onclick="carregarAgendaIgreja()"><span class="menu-icon">套</span> Agenda Igreja</button>`;
            }

            menu.innerHTML = html;
            
            // Adiciona evento para destacar o botﾃ｣o ativo
            const btns = menu.querySelectorAll('.menu-btn');
            btns.forEach(btn => {
                btn.addEventListener('click', function() {
                    btns.forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    // Fecha sidebar no mobile ao clicar
                    if(window.innerWidth <= 768) toggleSidebar();
                });
            });
        }

        // ============================================
        // 1. GESTﾃグ DE MEMBROS (SECRETARIA)
        // ============================================
        async function carregarCRUDMembros() {
            const container = document.getElementById('mainContainer');
            container.innerHTML = '<div class="panel-card"><p>Carregando membros...</p></div>';

            try {
                const res = await fetch(`${API_BASE}/membros`);
                const membros = await res.json();

                let linhas = membros.map(m => `
                    <tr>
                        <td>${m.NOME}</td>
                        <td>${m.CPF}</td>
                        <td>${m.CARGO}</td>
                        <td><span class="badge badge-${m.PERFIL ? m.PERFIL.toLowerCase() : 'membro'}">${m.PERFIL}</span></td>
                        <td>
                            <button class="btn-action btn-delete" onclick="deletarMembro('${m.ID}')">Excluir</button>
                        </td>
                    </tr>
                `).join('');

                container.innerHTML = `
                    <div class="panel-card">
                        <div class="panel-title">
                            <span>Gestﾃ｣o de Membros</span>
                            <button class="btn-add" onclick="abrirModalMembro()">+ Novo Membro</button>
                        </div>
                        <div style="overflow-x:auto;">
                            <table class="data-table">
                                <thead><tr><th>Nome</th><th>CPF</th><th>Cargo</th><th>Perfil</th><th>Aﾃｧﾃｵes</th></tr></thead>
                                <tbody>${linhas}</tbody>
                            </table>
                        </div>
                    </div>
                `;
            } catch (e) {
                container.innerHTML = `<div class="panel-card"><p style="color:red">Erro: ${e.message}</p></div>`;
            }
        }

        function abrirModalMembro() {
            const modalBody = document.getElementById('modalBody');
            document.getElementById('modalTitle').innerText = 'Cadastrar Novo Membro';
            
            modalBody.innerHTML = `
                <form onsubmit="salvarMembro(event)">
                    <div class="form-group">
                        <label>Nome Completo</label>
                        <input type="text" id="m_nome" class="form-input" required>
                    </div>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>CPF (Sﾃｳ nﾃｺmeros)</label>
                            <input type="text" id="m_cpf" class="form-input" required>
                        </div>
                        <div class="form-group">
                            <label>Data Nasc (DD/MM/AAAA)</label>
                            <input type="text" id="m_nasc" class="form-input" placeholder="Ex: 25/12/1990" required>
                        </div>
                    </div>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Perfil de Acesso</label>
                            <select id="m_perfil" class="form-input">
                                <option value="MEMBRO">Membro (Padrﾃ｣o)</option>
                                <option value="PASTOR">Pastor</option>
                                <option value="SECRETARIA">Secretaria</option>
                                <option value="ADMIN">Admin</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Cargo</label>
                            <input type="text" id="m_cargo" class="form-input" placeholder="Ex: Diﾃ｡cono">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Senha (Opcional - Sﾃｳ p/ Admin/Pastor)</label>
                        <input type="text" id="m_senha" class="form-input" placeholder="Deixe em branco p/ membro">
                    </div>
                    <button type="submit" class="btn-add" style="width:100%">Salvar Cadastro</button>
                </form>
            `;
            document.getElementById('modalForm').classList.remove('hidden');
        }

        async function salvarMembro(e) {
            e.preventDefault();
            const btn = e.target.querySelector('button');
            btn.innerText = 'Salvando...';

            const payload = {
                NOME: document.getElementById('m_nome').value,
                CPF: document.getElementById('m_cpf').value,
                NASCIMENTO: document.getElementById('m_nasc').value,
                PERFIL: document.getElementById('m_perfil').value,
                CARGO: document.getElementById('m_cargo').value,
                SENHA: document.getElementById('m_senha').value
            };

            try {
                await fetch(`${API_BASE}/membros`, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'x-admin-token': 'admin_secret' // Simulaﾃｧﾃ｣o, no real seu backend pede token
                    },
                    body: JSON.stringify(payload)
                });
                fecharModal();
                carregarCRUDMembros(); // Recarrega a tabela
            } catch (err) {
                alert('Erro ao salvar');
            }
        }

        async function deletarMembro(id) {
            if(!confirm("Tem certeza que deseja excluir este membro?")) return;
            try {
                await fetch(`${API_BASE}/membros/${id}`, { 
                    method: 'DELETE',
                    headers: { 'x-admin-token': 'admin_secret' } 
                });
                carregarCRUDMembros();
            } catch (e) { alert("Erro ao deletar"); }
        }


        // ============================================
        // 2. GESTﾃグ AGENDA PASTOR (SECRETARIA)
        // ============================================
        async function carregarGestaoAgendaPastor() {
            const container = document.getElementById('mainContainer');
            container.innerHTML = '<div class="panel-card"><p>Carregando agenda...</p></div>';

            try {
                const res = await fetch(`${API_BASE}/agenda-pastor`);
                const agenda = await res.json();

                let linhas = agenda.map(a => `
                    <tr>
                        <td>${a.DATA}</td>
                        <td>${a.HORARIO || '-'}</td>
                        <td>${a.EVENTO}</td>
                        <td>${a.LOCAL || '-'}</td>
                        <td>
                            <button class="btn-action btn-delete" onclick="deletarEventoPastor('${a.ID}')">Excluir</button>
                        </td>
                    </tr>
                `).join('');

                container.innerHTML = `
                    <div class="panel-card">
                        <div class="panel-title">
                            <span>Agenda do Pastor</span>
                            <button class="btn-add" onclick="abrirModalAgenda()">+ Novo Compromisso</button>
                        </div>
                        <div style="overflow-x:auto;">
                            <table class="data-table">
                                <thead><tr><th>Data</th><th>Hora</th><th>Evento</th><th>Local</th><th>Aﾃｧﾃｵes</th></tr></thead>
                                <tbody>${linhas}</tbody>
                            </table>
                        </div>
                    </div>
                `;
            } catch (e) {
                container.innerHTML = `<div class="panel-card"><p>Erro: ${e.message}</p></div>`;
            }
        }

        function abrirModalAgenda() {
            const modalBody = document.getElementById('modalBody');
            document.getElementById('modalTitle').innerText = 'Agendar Compromisso';
            
            modalBody.innerHTML = `
                <form onsubmit="salvarEventoPastor(event)">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Data (DD/MM/AAAA)</label>
                            <input type="text" id="a_data" class="form-input" required>
                        </div>
                        <div class="form-group">
                            <label>Horﾃ｡rio</label>
                            <input type="text" id="a_hora" class="form-input" placeholder="19:00">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Evento / Compromisso</label>
                        <input type="text" id="a_evento" class="form-input" required>
                    </div>
                    <div class="form-group">
                        <label>Local</label>
                        <input type="text" id="a_local" class="form-input">
                    </div>
                    <div class="form-group">
                        <label>Observaﾃｧﾃ｣o</label>
                        <input type="text" id="a_obs" class="form-input">
                    </div>
                    <button type="submit" class="btn-add" style="width:100%">Salvar na Agenda</button>
                </form>
            `;
            document.getElementById('modalForm').classList.remove('hidden');
        }

        async function salvarEventoPastor(e) {
            e.preventDefault();
            const payload = {
                DATA: document.getElementById('a_data').value,
                HORARIO: document.getElementById('a_hora').value,
                EVENTO: document.getElementById('a_evento').value,
                LOCAL: document.getElementById('a_local').value,
                OBSERVACAO: document.getElementById('a_obs').value
            };

            try {
                await fetch(`${API_BASE}/agenda-pastor`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'x-admin-token': 'admin_secret' },
                    body: JSON.stringify(payload)
                });
                fecharModal();
                carregarGestaoAgendaPastor();
            } catch (err) { alert('Erro ao salvar'); }
        }

        async function deletarEventoPastor(id) {
            if(!confirm("Excluir este compromisso?")) return;
            try {
                await fetch(`${API_BASE}/agenda-pastor/${id}`, { 
                    method: 'DELETE', 
                    headers: { 'x-admin-token': 'admin_secret' }
                });
                carregarGestaoAgendaPastor();
            } catch (e) { alert("Erro ao deletar"); }
        }

        // ============================================
        // 3. VISUALIZAﾃﾃグ DO PASTOR
        // ============================================
        async function carregarVisaoPastor() {
            const container = document.getElementById('mainContainer');
            container.innerHTML = '<div class="panel-card"><p>Carregando suas agendas...</p></div>';

            try {
                const [resPastor, resIgreja] = await Promise.all([
                    fetch(`${API_BASE}/agenda-pastor`),
                    fetch(`${API_BASE}/patrimonio/dados`)
                ]);
                const agendaPastor = await resPastor.json();
                const dadosIgreja = await resIgreja.json();

                container.innerHTML = `
                    <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                        <div class="panel-card" style="border-top: 4px solid #3b82f6;">
                            <div class="panel-title">藻 Meus Compromissos</div>
                            ${renderListaSimples(agendaPastor, 'pessoal')}
                        </div>
                        <div class="panel-card" style="border-top: 4px solid #dc2626;">
                            <div class="panel-title">笵ｪ Agenda da Igreja</div>
                            ${renderListaSimples(dadosIgreja.agenda, 'igreja')}
                        </div>
                    </div>
                `;
            } catch (e) { container.innerHTML = 'Erro ao carregar'; }
        }

        function renderListaSimples(lista, tipo) {
            if(!lista || lista.length === 0) return '<p>Nada agendado.</p>';
            
            // Ordena datas
            lista.sort((a,b) => parseDate(a.DATA||a.data) - parseDate(b.DATA||b.data));

            return lista.map(i => {
                const data = i.DATA || i.data;
                const titulo = i.EVENTO || i.evento;
                const extra = tipo === 'pessoal' ? (i.LOCAL || '') : (i.local || '');
                return `
                    <div style="padding:10px; border-bottom:1px solid #eee; display:flex; gap:10px;">
                        <div style="font-weight:bold; color:${tipo==='pessoal'?'#2563eb':'#dc2626'}; min-width:80px;">${data}</div>
                        <div>
                            <div style="font-weight:600;">${titulo}</div>
                            <div style="font-size:0.85rem; color:#64748b;">${extra}</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // ============================================
        // 4. MOCKS (Placeholders)
        // ============================================
        function carregarVisaoSecretaria() {
            document.getElementById('mainContainer').innerHTML = `
                <div class="panel-card">
                    <h2>Olﾃ｡, Secretaria</h2>
                    <p>Use o menu lateral para gerenciar os membros e a agenda pastoral.</p>
                </div>
            `;
        }

        function carregarVisaoMembro() {
             document.getElementById('mainContainer').innerHTML = `
                <div class="panel-card">
                    <h2>Olﾃ｡, ${usuario.NOME}</h2>
                    <p>Bem-vindo ao seu portal.</p>
                    <p><strong>Cargo:</strong> ${usuario.CARGO}</p>
                </div>
            `;
        }

        // Utilitﾃ｡rios
        function fecharModal() { document.getElementById('modalForm').classList.add('hidden'); }
        function abrirEBD() { window.location.href = '/'; }
        function parseDate(str) { if(!str) return new Date(0); const p = str.split('/'); return new Date(p[2], p[1]-1, p[0]); }

    </script>
</body>
</html>
